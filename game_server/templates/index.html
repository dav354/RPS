<!DOCTYPE html>
<html lang="en" class="">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rock Paper Scissors Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    /* Custom transition for dark mode */
    .theme-transition {
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Pulse animation for status dots */
    @keyframes pulse {
      50% {
        opacity: .5;
      }
    }

    .animate-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
  </style>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'primary': {
              '50': '#eff6ff', '100': '#dbeafe', '200': '#bfdbfe', '300': '#93c5fd', '400': '#60a5fa', '500': '#3b82f6', '600': '#2563eb', '700': '#1d4ed8', '800': '#1e40af', '900': '#1e3a8a'
            }
          }
        }
      }
    }
  </script>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 theme-transition">

  <!-- Navigation -->
  <nav class="bg-white dark:bg-gray-800 shadow-md">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center">
          <span class="font-bold text-xl text-primary-600 dark:text-primary-400">Rock Paper Scissors</span>
        </div>
        <div class="flex items-center space-x-4">
          <span id="system-status-indicator" title="System Status">
            <!-- Status dot will be inserted here by JS -->
          </span>
          <button id="darkModeToggle"
            class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none">
            <!-- SVG Icon will be inserted here by JS -->
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="container mx-auto px-4 sm:px-6 lg:px-8 mt-8">
    <!-- Added lg:items-center to vertically align columns on large screens -->
    <div class="flex flex-wrap -mx-4 lg:items-center">

      <!-- Left Column: Camera Feed -->
      <div class="w-full lg:w-2/3 px-4 mb-8 lg:mb-0">
        <div class="aspect-w-4 aspect-h-3 bg-gray-300 dark:bg-gray-700 rounded-lg shadow-lg overflow-hidden">
          <img src="{{ url_for('video_feed_route') }}" id="camera-stream" class="w-full h-full object-cover"
            onerror="this.onerror=null;this.src='https://placehold.co/640x480/374151/e5e7eb?text=Camera+Feed+Offline';" />
        </div>
      </div>

      <!-- Right Column: Stats -->
      <div class="w-full lg:w-1/3 px-4">
        <div class="space-y-6">
          <!-- Gesture Card -->
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-300">Detection</h3>
            <div class="space-y-2">
              <p><strong>Gesture:</strong> <span id="gesture" class="font-mono">…</span></p>
              <p><strong>Confidence:</strong> <span id="confidence" class="font-mono">…</span></p>
            </div>
          </div>
          <!-- Performance Card -->
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-300">Performance</h3>
            <div class="space-y-2">
              <p><strong>FPS:</strong> <span id="fps" class="font-mono">…</span></p>
              <p><strong>Inference:</strong> <span id="infer" class="font-mono">…</span> ms</p>
            </div>
          </div>
          <!-- System Card -->
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-300">System</h3>
            <div class="space-y-2">
              <p><strong>CPU:</strong> <span id="cpu" class="font-mono">…</span> %</p>
              <p><strong>Temp:</strong> <span id="cpu_temp" class="font-mono">…</span> °C</p>
              <p><strong>RAM:</strong> <span id="ram" class="font-mono">…</span></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Game Control Panel -->
    <!-- Changed p-6 to p-2 -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg mt-8 p-2">
      <!-- Changed items-center to items-stretch -->
      <div class="flex items-stretch justify-between flex-wrap">
        <!-- Button Wrapper -->
        <div class="w-full sm:w-auto mb-4 sm:mb-0">
          <!-- Removed py padding, added h-full to make it stretch. Increased font/icon size. -->
          <button id="playBtn"
            class="h-full w-full sm:w-auto flex items-center justify-center px-6 border border-transparent text-xl font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 dark:bg-green-500 dark:hover:bg-green-600 theme-transition">
            <svg id="playBtnIcon" class="h-8 w-8 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span id="playBtnText">Start Game</span>
          </button>
        </div>

        <!-- Score Info Wrapper. Added py-4 to give it some vertical space. -->
        <div class="flex-grow text-center mx-4 py-4">
          <div id="match" class="text-sm text-gray-500 dark:text-gray-400 tracking-wider uppercase">Waiting to Start
          </div>
          <div id="score" class="flex items-center justify-center my-1">
            <span id="computer-score" class="text-4xl font-bold w-16 text-right">0</span>
            <span class="text-3xl font-light mx-4 text-gray-400 dark:text-gray-500">:</span>
            <span id="player-score" class="text-4xl font-bold w-16 text-left">0</span>
          </div>
          <div id="result" class="text-lg font-semibold text-primary-600 dark:text-primary-400 h-7">Press 'Start Game'
            to begin!</div>
        </div>

        <!-- Spacer -->
        <div class="w-full sm:w-auto invisible sm:visible flex items-center">
          <!-- Adjusted spacer width for layout balance -->
          <div class="w-60"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // --- DOM Element References ---
      const playBtn = document.getElementById("playBtn");
      const playBtnIcon = document.getElementById("playBtnIcon");
      const playBtnText = document.getElementById("playBtnText");
      const darkModeToggle = document.getElementById('darkModeToggle');
      const systemStatusIndicator = document.getElementById('system-status-indicator');

      // --- UI Elements for Game State ---
      const roundInfoEl = document.getElementById("match");
      const computerScoreEl = document.getElementById("computer-score");
      const playerScoreEl = document.getElementById("player-score");
      const resultEl = document.getElementById("result");

      // --- Game State & Timers ---
      let gameActive = false;
      let statePollInterval;

      // --- SVG Icons ---
      const sunIcon = `<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`;
      const moonIcon = `<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`;
      const playIconPath = "M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z";
      const stopIconPath = "M10 9v6m4-6v6";

      // --- Dark Mode Logic ---
      const applyDarkMode = (isDark) => {
        if (isDark) {
          document.documentElement.classList.add('dark');
          darkModeToggle.innerHTML = sunIcon;
        } else {
          document.documentElement.classList.remove('dark');
          darkModeToggle.innerHTML = moonIcon;
        }
      };

      darkModeToggle.addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
        applyDarkMode(isDark);
      });

      // Initialize dark mode
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const savedTheme = localStorage.getItem('darkMode');
      applyDarkMode(savedTheme === 'enabled' || (savedTheme !== 'disabled' && prefersDark));


      // --- Data Fetching ---
      async function fetchSystemStats() {
        try {
          const res = await fetch('/gesture_data');
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          const stats = await res.json();

          // Update system status indicator
          const isOk = stats.tpu && stats.camera;
          systemStatusIndicator.innerHTML = `<span class="block w-3 h-3 rounded-full ${isOk ? 'bg-green-500' : 'bg-red-500 animate-pulse'}"></span>`;
          systemStatusIndicator.title = isOk ? "System OK" : `Error: ${!stats.tpu ? 'TPU' : ''} ${!stats.camera ? 'Camera' : ''} unavailable`;

          // Update stats display
          document.getElementById('gesture').textContent = stats.gesture;
          document.getElementById('confidence').textContent = stats.confidence;
          document.getElementById('fps').textContent = stats.fps;
          document.getElementById('infer').textContent = stats.inference_ms;
          document.getElementById('cpu').textContent = stats.cpu;
          document.getElementById('ram').textContent = stats.ram;
          document.getElementById('cpu_temp').textContent = stats.cpu_temp || 'N/A';

        } catch (error) {
          console.error("Failed to fetch system stats:", error);
          systemStatusIndicator.innerHTML = `<span class="block w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></span>`;
          systemStatusIndicator.title = "Failed to fetch stats";
        }
      }

      // --- UI Update Logic ---
      function updateButtonUI() {
        playBtn.classList.toggle("bg-green-600", !gameActive);
        playBtn.classList.toggle("hover:bg-green-700", !gameActive);
        playBtn.classList.toggle("dark:bg-green-500", !gameActive);
        playBtn.classList.toggle("dark:hover:bg-green-600", !gameActive);

        playBtn.classList.toggle("bg-red-600", gameActive);
        playBtn.classList.toggle("hover:bg-red-700", gameActive);
        playBtn.classList.toggle("dark:bg-red-500", gameActive);
        playBtn.classList.toggle("dark:hover:bg-red-600", gameActive);

        playBtnText.textContent = gameActive ? "Stop Game" : "Start Game";
        playBtnIcon.querySelector('path:first-of-type').setAttribute('d', gameActive ? stopIconPath : playIconPath);
      }

      function updateGameUI(state) {
        const { score, current_round, total_rounds, result, game_over } = state;

        computerScoreEl.textContent = score.computer;
        playerScoreEl.textContent = score.player;
        resultEl.textContent = result;

        if (current_round > 0) {
          roundInfoEl.textContent = `Round ${Math.min(current_round, total_rounds)} of ${total_rounds}`;
        } else {
          roundInfoEl.textContent = "Waiting to Start";
        }

        if ((game_over || current_round === 0) && gameActive) {
          gameActive = false;
          stopPolling();
          updateButtonUI();
        }
      }

      // --- Polling Logic ---
      function stopPolling() {
        clearInterval(statePollInterval);
        statePollInterval = null;
      }

      function startPolling() {
        if (statePollInterval) return;
        statePollInterval = setInterval(() => {
          if (!gameActive) {
            stopPolling();
            return;
          }
          fetch("/game_state").then(res => res.json()).then(updateGameUI)
            .catch(err => {
              console.error("Error polling game state:", err);
              gameActive = false;
              updateButtonUI();
            });
        }, 500);
      }

      // --- Main Game Control ---
      async function toggleGame() {
        if (gameActive) {
          gameActive = false;
          await fetch("/stop_game");
          stopPolling();
        } else {
          const res = await fetch("/start_game");
          const data = await res.json();
          if (data.status === 'ok') {
            gameActive = true;
            startPolling();
          } else {
            // In a real app, you'd use a more robust notification system
            alert(`Error: ${data.message}`);
          }
        }
        updateButtonUI();
      }

      // --- Initial Setup ---
      playBtn.addEventListener("click", toggleGame);
      setInterval(fetchSystemStats, 2000);
      fetchSystemStats(); // Initial fetch
      fetch("/game_state").then(res => res.json()).then(updateGameUI); // Initial state
    });
  </script>
</body>

</html>